# Backend –¥–ª—è Telegram –ë–∞—Ä–∞—Ö–æ–ª–∫–∞ MiniApp

Backend —Å–µ—Ä–≤–µ—Ä –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å Telegram Bot API –∏ –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö –æ–±—ä—è–≤–ª–µ–Ω–∏–π.

## –§—É–Ω–∫—Ü–∏–∏

- üîó **–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Telegram Bot API** - –ø—É–±–ª–∏–∫–∞—Ü–∏—è –æ–±—ä—è–≤–ª–µ–Ω–∏–π –≤ –∫–∞–Ω–∞–ª—ã
- üóÑÔ∏è **SQLite –±–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö** - —Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –æ–±—ä—è–≤–ª–µ–Ω–∏–π
- üì∏ **–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π** - –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è –∏ –∑–∞–≥—Ä—É–∑–∫–∞ –≤ Telegram
- üèôÔ∏è **–ú—É–ª—å—Ç–∏–≥–æ—Ä–æ–¥** - –ø–æ–¥–¥–µ—Ä–∂–∫–∞ —Ä–∞–∑–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤ —Å –æ—Ç–¥–µ–ª—å–Ω—ã–º–∏ –∫–∞–Ω–∞–ª–∞–º–∏
- üîí **–°–∏—Å—Ç–µ–º–∞ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤** - –∫–æ–Ω—Ç—Ä–æ–ª—å –ø—É–±–ª–∏–∫–∞—Ü–∏–π –∏ –∞–Ω—Ç–∏—Ñ–ª—É–¥
- üì± **REST API** - –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å frontend

## –£—Å—Ç–∞–Ω–æ–≤–∫–∞

### 1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
```bash
cd backend
npm install
```

### 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
```bash
cp env.example .env
```

–û—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–π—Ç–µ `.env` —Ñ–∞–π–ª:
```env
# Telegram Bot Configuration
TELEGRAM_BOT_TOKEN=your_bot_token_here
TELEGRAM_WEBHOOK_URL=https://your-domain.com/webhook

# Database Configuration
DATABASE_PATH=./database/bazaar.db

# Server Configuration
PORT=3001
NODE_ENV=development

# City Channels Configuration
CITY_CHANNELS={"saratov": "@saratov_bazaar", "moscow": "@moscow_bazaar", "spb": "@spb_bazaar"}

# CORS Configuration
CORS_ORIGIN=http://localhost:3000
```

### 3. –°–æ–∑–¥–∞–Ω–∏–µ Telegram –±–æ—Ç–∞

1. –°–æ–∑–¥–∞–π—Ç–µ –±–æ—Ç–∞ —á–µ—Ä–µ–∑ @BotFather
2. –ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –±–æ—Ç–∞
3. –î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω –≤ `.env` —Ñ–∞–π–ª
4. –°–æ–∑–¥–∞–π—Ç–µ –∫–∞–Ω–∞–ª—ã –¥–ª—è –≥–æ—Ä–æ–¥–æ–≤ (–Ω–∞–ø—Ä–∏–º–µ—Ä, @saratov_bazaar)
5. –î–æ–±–∞–≤—å—Ç–µ –±–æ—Ç–∞ –≤ –∫–∞–Ω–∞–ª—ã –∫–∞–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
6. –û–±–Ω–æ–≤–∏—Ç–µ `CITY_CHANNELS` –≤ `.env`

### 4. –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–µ—Ä–∞

```bash
# –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞
npm run dev

# –ü—Ä–æ–¥–∞–∫—à–µ–Ω
npm start
```

## API Endpoints

### –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏

#### `GET /api/users/:telegram_id`
–ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

#### `POST /api/users`
–°–æ–∑–¥–∞—Ç—å –∏–ª–∏ –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```json
{
  "telegram_id": 12345,
  "first_name": "–ò–≤–∞–Ω",
  "last_name": "–ò–≤–∞–Ω–æ–≤",
  "username": "ivan_user",
  "photo_url": "https://..."
}
```

#### `PUT /api/users/:telegram_id/crystals`
–û–±–Ω–æ–≤–∏—Ç—å –∫—Ä–∏—Å—Ç–∞–ª–ª—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
```json
{
  "crystals": 3,
  "last_crystal_time": "2024-01-01T12:00:00Z"
}
```

#### `PUT /api/users/:telegram_id/city`
–û–±–Ω–æ–≤–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥
```json
{
  "city": "saratov"
}
```

### –ü—É–±–ª–∏–∫–∞—Ü–∏–∏

#### `GET /api/publications/city/:city`
–ü–æ–ª—É—á–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –ø–æ –≥–æ—Ä–æ–¥—É
```
GET /api/publications/city/saratov?limit=50&offset=0
```

#### `GET /api/publications/:id`
–ü–æ–ª—É—á–∏—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é

#### `POST /api/publications`
–°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—É—é –ø—É–±–ª–∏–∫–∞—Ü–∏—é
```javascript
const formData = new FormData();
formData.append('telegram_id', 12345);
formData.append('city', 'saratov');
formData.append('title', '–ü—Ä–æ–¥–∞–º iPhone');
formData.append('description', '–û—Ç–ª–∏—á–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ');
formData.append('price', 50000);
formData.append('images', file1);
formData.append('images', file2);
```

#### `DELETE /api/publications/:id`
–£–¥–∞–ª–∏—Ç—å –ø—É–±–ª–∏–∫–∞—Ü–∏—é
```json
{
  "telegram_id": 12345
}
```

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö

### –¢–∞–±–ª–∏—Ü–∞ `users`
- `id` - Primary key
- `telegram_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ Telegram
- `first_name`, `last_name`, `username`, `photo_url` - –î–∞–Ω–Ω—ã–µ –ø—Ä–æ—Ñ–∏–ª—è
- `crystals` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤
- `last_crystal_time` - –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –∫—Ä–∏—Å—Ç–∞–ª–ª–∞
- `last_publication_time` - –í—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–π –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- `selected_city` - –í—ã–±—Ä–∞–Ω–Ω—ã–π –≥–æ—Ä–æ–¥

### –¢–∞–±–ª–∏—Ü–∞ `publications`
- `id` - Primary key
- `user_id` - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- `city` - –ì–æ—Ä–æ–¥ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
- `title`, `description`, `price` - –î–∞–Ω–Ω—ã–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è
- `images` - JSON –º–∞—Å—Å–∏–≤ URL –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- `telegram_message_id` - ID —Å–æ–æ–±—â–µ–Ω–∏—è –≤ Telegram
- `telegram_chat_id` - ID –∫–∞–Ω–∞–ª–∞ –≤ Telegram
- `status` - –°—Ç–∞—Ç—É—Å (active, deleted, expired)

## –†–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Heroku
1. –°–æ–∑–¥–∞–π—Ç–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ Heroku
2. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
3. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
4. –í–∫–ª—é—á–∏—Ç–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ä–∞–∑–≤–µ—Ä—Ç—ã–≤–∞–Ω–∏–µ

### Vercel
1. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ Vercel CLI: `npm i -g vercel`
2. –í –ø–∞–ø–∫–µ backend: `vercel`
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è

### DigitalOcean App Platform
1. –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤–æ–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ
2. –ü–æ–¥–∫–ª—é—á–∏—Ç–µ GitHub —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–π
3. –ù–∞—Å—Ç—Ä–æ–π—Ç–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
4. –£–∫–∞–∂–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É –∑–∞–ø—É—Å–∫–∞: `npm start`

### VPS (Ubuntu/Debian)
```bash
# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js
curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
sudo apt-get install -y nodejs

# –ö–ª–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è
git clone your-repo
cd your-repo/backend

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
npm install --production

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ PM2
sudo npm install -g pm2

# –ó–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
pm2 start server.js --name bazaar-backend
pm2 save
pm2 startup
```

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### –õ–æ–≥–∏
```bash
# PM2 –ª–æ–≥–∏
pm2 logs bazaar-backend

# –°–∏—Å—Ç–µ–º–Ω—ã–µ –ª–æ–≥–∏
journalctl -u your-app-service
```

### Health Check
```
GET /api/health
```

## –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å

- ‚úÖ –í–∞–ª–∏–¥–∞—Ü–∏—è –≤—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Ñ–∞–π–ª–æ–≤ (10MB)
- ‚úÖ CORS –Ω–∞—Å—Ç—Ä–æ–π–∫–∏
- ‚úÖ –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
- ‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ rate limiting –¥–ª—è –ø—Ä–æ–¥–∞–∫—à–µ–Ω–∞
- ‚ö†Ô∏è –ù–∞—Å—Ç—Ä–æ–π—Ç–µ HTTPS
- ‚ö†Ô∏è –î–æ–±–∞–≤—å—Ç–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é –¥–ª—è –∞–¥–º–∏–Ω—Å–∫–∏—Ö —Ñ—É–Ω–∫—Ü–∏–π

## –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ

–î–ª—è –≤—ã—Å–æ–∫–∏—Ö –Ω–∞–≥—Ä—É–∑–æ–∫ —Ä–∞—Å—Å–º–æ—Ç—Ä–∏—Ç–µ:
- PostgreSQL –≤–º–µ—Å—Ç–æ SQLite
- Redis –¥–ª—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
- CDN –¥–ª—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- Load balancer
- –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å–Ω–∞—è –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –ø—Ä–æ–±–ª–µ–º:
1. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞
2. –£–±–µ–¥–∏—Ç–µ—Å—å –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫ Telegram Bot
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∫–∞–Ω–∞–ª–æ–≤
4. –°–æ–∑–¥–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
